<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Cashbook</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            padding: 5px;
            background-color: #f4f4f4; 
            color: #333; 
        }
        .container { 
            max-width: 800px; 
            margin: auto; 
            background: #fff; 
            padding: 10px;
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding-bottom: 80px; 
        }
        h1, h2 { color: #0056b3; text-align: center; }
        
        .balance-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .data-card { 
            flex: 1;
            min-width: 200px;
            margin-bottom: 10px; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: white;
        }
        .data-card h3 { 
            font-size: 1.1em; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .data-card p { margin: 0; font-size: 2.2em; font-weight: bold; }

        /* --- NEW STYLES FOR INDIVIDUAL BALANCES --- */
        #individual-balances {
            margin-top: 15px;
            font-size: 0.8em;
            text-align: left;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 10px;
        }
        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 5px;
        }
        .balance-item span:first-child {
            font-weight: normal;
        }
        .balance-item span:last-child {
            font-weight: bold;
        }


        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filters label, .filters input, .filters button { font-size: 1em; }
        .filters button { background-color: #28a745; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; transition: background-color 0.3s ease; }
        .filters button:hover { background-color: #218838; }
        
        .transaction-card {
            background-color: #f2f2f2;
            color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            transition: background-color 0.3s ease;
        }
        .card-header, .card-footer {
             display: flex; justify-content: space-between; align-items: center;
        }
        .card-header { font-weight: bold; font-size: 1.2em; margin-bottom: 5px; }
        .card-footer { font-size: 0.9em; }

        .input-form {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .input-form input, .input-form select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .input-form .full-width { grid-column: 1 / -1; }
        .input-form button {
            background-color: #007bff; color: white; border: none; padding: 12px 15px;
            cursor: pointer; border-radius: 5px; transition: background-color 0.3s ease;
            width: 100%; grid-column: 1 / -1; font-size: 1.1em;
        }
        .input-form button:hover { background-color: #0056b3; }
        
        .message-box {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background-color: white; padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000; display: none; text-align: center;
        }
        .message-box p { margin: 0 0 15px 0; font-size: 1.1em; }
        .message-box button {
            background-color: #007bff; color: white; border: none;
            padding: 8px 15px; cursor: pointer; border-radius: 4px;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background-color: #ffffff;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            padding: 10px 0;
            z-index: 100;
        }
        .tab-link {
            flex: 1;
            text-align: center;
            background: none;
            border: none;
            font-size: 1em;
            color: #888;
            cursor: pointer;
            padding: 10px 5px;
            transition: color 0.3s ease;
        }
        .tab-link.active {
            color: #007bff;
            font-weight: bold;
        }
        .tab-link:hover {
            color: #0056b3;
        }

        .page-content { display: block; }
        .page-content.hidden { display: none; }
        
        #accounts-page h2 { margin-bottom: 20px; }
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-account-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .add-account-form input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .add-account-form button { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <!-- PAGE 1: HOME -->
    <div id="home-page" class="page-content">
        <h1>ADVANCED CASHBOOK</h1>
        <div class="balance-container">
            <!-- MODIFIED: Single combined balance card -->
            <div class="data-card" style="background-color: #007bff;">
                <h3>Total Account Balance</h3>
                <p id="total-balance">0</p>
                <div id="individual-balances">
                    <!-- Individual balances will be populated here by JavaScript -->
                </div>
            </div>
        </div>
        <div class="input-form">
            <input type="date" id="add-date" name="date" required="true" />
            <select id="add-type" name="type" required="true">
                <option value="INCOME">INCOME</option>
                <option value="EXPENSE">EXPENSE</option>
            </select>
            <select id="add-category" name="category" required="true">
                <option value="" disabled="true" selected="true">Select Category</option>
                <option value="BY AKD">BY AKD</option>
                <option value="OFFICE ESSENTIAL">OFFICE ESSENTIAL</option>
                <option value="FOOD">FOOD</option>
                <option value="PRINT OUT">PRINT OUT</option>
                <option value="OTHER">OTHER</option>
            </select>
            <select id="add-paymentMode" name="paymentMode" required="true">
                <!-- Options will be populated by JavaScript -->
            </select>
            <input type="number" id="add-amount" name="amount" placeholder="Amount" required="true" />
            <input type="text" id="add-description" name="description" placeholder="Description" class="full-width" required="true" />
            <button onclick="addData()">ADD DATA</button>
        </div>
    </div>
    
    <!-- PAGE 2: ACCOUNTS -->
    <div id="accounts-page" class="page-content hidden">
        <h2>Manage Accounts</h2>
        <div id="accounts-list"></div>
        <div class="add-account-form">
            <input type="text" id="new-account-name" placeholder="New Account Name">
            <button onclick="addAccount()">Add Account</button>
        </div>
    </div>

    <!-- PAGE 3: TRANSACTIONS -->
    <div id="transaction-page" class="page-content hidden">
        <h2>Transactions</h2>
        <div class="filters">
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" />
            <label for="end-date">End Date:</label>
            <input type="date" id="end-date" />
            <button onclick="fetchData()">APPLY</button>
        </div>
        <div id="data-container"></div>
        <div id="load-more-container" style="text-align: center; margin-top: 20px;">
            <button id="load-more-btn" onclick="loadMore()" style="padding: 10px 20px; font-size: 1em; cursor: pointer; display: none; border-radius: 5px; border: 1px solid #007bff; background-color: #fff; color: #007bff;">Load More</button>
        </div>
    </div>
</div>

<div id="messageBox" class="message-box">
    <p id="messageText"></p>
    <button onclick="hideMessage()">OK</button>
</div>

<div class="tab-bar">
    <button class="tab-link active" onclick="handleTabClick('Home', this)">Home</button>
    <button class="tab-link" onclick="handleTabClick('Category', this)">Category</button>
    <button class="tab-link" onclick="handleTabClick('Accounts', this)">Accounts</button>
    <button class="tab-link" onclick="handleTabClick('Transaction', this)">Transaction</button>
</div>

<script>
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbzrRUUZcbkIQvX_Noo3zBRODKm34EhkkyowpBVyVxmGFMTGDw1nKCWXgFLKCLetWVY2/exec';
    const ACCOUNTS_STORAGE_KEY = 'cashbookAccounts';

    let allTransactions = [];
    let currentlyDisplayedCount = 0;
    const transactionsPerLoad = 10;

    function showMessage(message) {
        document.getElementById('messageText').innerText = message;
        document.getElementById('messageBox').style.display = 'block';
    }

    function hideMessage() {
        document.getElementById('messageBox').style.display = 'none';
    }

    function handleTabClick(tabName, element) {
        document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
        element.classList.add('active');

        document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
        
        if (tabName === 'Home') {
            document.getElementById('home-page').classList.remove('hidden');
        } else if (tabName === 'Accounts') {
            document.getElementById('accounts-page').classList.remove('hidden');
            renderAccountsList();
        } else if (tabName === 'Transaction') {
            document.getElementById('transaction-page').classList.remove('hidden');
            fetchData();
        } else {
            document.getElementById('home-page').classList.remove('hidden');
            showMessage(`${tabName} feature is not yet implemented.`);
        }
    }

    function getAccounts() {
        const storedAccounts = localStorage.getItem(ACCOUNTS_STORAGE_KEY);
        if (storedAccounts) {
            return JSON.parse(storedAccounts);
        } else {
            const defaultAccounts = ['IndusInd (Regular)', 'Cash'];
            localStorage.setItem(ACCOUNTS_STORAGE_KEY, JSON.stringify(defaultAccounts));
            return defaultAccounts;
        }
    }

    function saveAccounts(accounts) {
        localStorage.setItem(ACCOUNTS_STORAGE_KEY, JSON.stringify(accounts));
        populatePaymentModesDropdown();
    }
    
    function renderAccountsList() {
        const accounts = getAccounts();
        const listContainer = document.getElementById('accounts-list');
        listContainer.innerHTML = '';
        
        accounts.forEach(accountName => {
            const item = document.createElement('div');
            item.className = 'account-item';
            item.innerHTML = `
                <span>${accountName}</span>
                <button class="remove-btn" onclick="removeAccount('${accountName}')">Remove</button>
            `;
            listContainer.appendChild(item);
        });
    }

    function addAccount() {
        const input = document.getElementById('new-account-name');
        const newName = input.value.trim();
        if (!newName) {
            showMessage('Account name cannot be empty.');
            return;
        }
        const accounts = getAccounts();
        if (accounts.map(a => a.toLowerCase()).includes(newName.toLowerCase())) {
            showMessage('This account name already exists.');
            return;
        }
        accounts.push(newName);
        saveAccounts(accounts);
        renderAccountsList();
        input.value = '';
    }

    function removeAccount(accountNameToRemove) {
        let accounts = getAccounts();
        accounts = accounts.filter(name => name !== accountNameToRemove);
        saveAccounts(accounts);
        renderAccountsList();
    }

    function populatePaymentModesDropdown() {
        const accounts = getAccounts();
        const select = document.getElementById('add-paymentMode');
        select.innerHTML = '<option value="" disabled="true" selected="true">Payment Mode</option>';
        
        accounts.forEach(accountName => {
            const option = document.createElement('option');
            option.value = accountName;
            option.innerText = accountName;
            select.appendChild(option);
        });
    }

    function clearFormFields() {
        document.getElementById('add-date').value = '';
        document.getElementById('add-type').selectedIndex = 0;
        document.getElementById('add-category').selectedIndex = 0;
        document.getElementById('add-paymentMode').selectedIndex = 0;
        document.getElementById('add-amount').value = '';
        document.getElementById('add-description').value = '';
    }

    function fetchData() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        const url = new URL(webAppUrl);
        if (startDate) url.searchParams.append('startDate', startDate);
        if (endDate) url.searchParams.append('endDate', endDate);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const currencyFormat = { style: 'currency', currency: 'INR' };
                
                // --- MODIFIED: Process dynamic account balances ---
                const accountBalances = data.accountBalances || {};
                const totalBalanceElement = document.getElementById('total-balance');
                const individualBalancesContainer = document.getElementById('individual-balances');
                
                let totalBalance = 0;
                individualBalancesContainer.innerHTML = ''; // Clear previous entries

                // Sort accounts alphabetically for consistent order
                const sortedAccounts = Object.keys(accountBalances).sort();

                for (const accountName of sortedAccounts) {
                    const balance = accountBalances[accountName];
                    totalBalance += balance;
                    
                    // Create and append the individual balance item
                    const item = document.createElement('div');
                    item.className = 'balance-item';
                    item.innerHTML = `
                        <span>${accountName}:</span>
                        <span>${new Intl.NumberFormat('en-IN', currencyFormat).format(balance)}</span>
                    `;
                    individualBalancesContainer.appendChild(item);
                }

                totalBalanceElement.innerText = new Intl.NumberFormat('en-IN', currencyFormat).format(totalBalance);

                // --- End of modification ---
                
                allTransactions = data.tableRows ? data.tableRows.reverse() : [];
                document.getElementById('data-container').innerHTML = '';
                currentlyDisplayedCount = 0;
                
                displayTransactions();
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                showMessage('Error fetching data. Check console for details.');
            });
    }

    function displayTransactions() {
        const dataContainer = document.getElementById('data-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const currencyFormat = { style: 'currency', currency: 'INR' };

        if (allTransactions.length === 0 && currentlyDisplayedCount === 0) {
            dataContainer.innerHTML = '<p style="text-align:center;">No transactions found for the selected date range.</p>';
            loadMoreBtn.style.display = 'none';
            return;
        }

        const start = currentlyDisplayedCount;
        const end = Math.min(start + transactionsPerLoad, allTransactions.length);

        for (let i = start; i < end; i++) {
            const row = allTransactions[i];
            const dateCell = row[0], typeCell = row[1], categoryCell = row[2], 
                  amountCell = row[3], descriptionCell = row[4], paymentModeCell = row[5] || ''; 

            const card = document.createElement('div');
            card.classList.add('transaction-card');
            
            if (typeCell.toUpperCase() === 'INCOME') {
                card.style.backgroundColor = '#28a745';
                card.style.color = 'white';
            } else {
                card.style.backgroundColor = '#dc3545';
                card.style.color = 'white';
            }

            const header = document.createElement('div');
            header.classList.add('card-header');
            const categorySpan = document.createElement('span');
            categorySpan.innerText = categoryCell;
            header.appendChild(categorySpan);
            const amountSpan = document.createElement('span');
            amountSpan.innerText = new Intl.NumberFormat('en-IN', currencyFormat).format(Math.abs(amountCell));
            if (card.style.color === 'white') {
                amountSpan.style.color = 'white';
            }
            header.appendChild(amountSpan);
            card.appendChild(header);

            const footer = document.createElement('div');
            footer.classList.add('card-footer');
            const descriptionSpan = document.createElement('span');
            descriptionSpan.innerText = descriptionCell;
            footer.appendChild(descriptionSpan);
            const date = new Date(dateCell);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const dateSpan = document.createElement('span');
            dateSpan.innerText = `${day}-${month}-${year}`;
            footer.appendChild(dateSpan);
            card.appendChild(footer);

            dataContainer.appendChild(card);
        }

        currentlyDisplayedCount = end;

        if (currentlyDisplayedCount < allTransactions.length) {
            loadMoreBtn.style.display = 'inline-block';
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    function loadMore() {
        displayTransactions();
    }

    function addData() {
        const date = document.getElementById('add-date').value;
        const type = document.getElementById('add-type').value;
        const category = document.getElementById('add-category').value;
        const amount = document.getElementById('add-amount').value;
        const description = document.getElementById('add-description').value;
        const paymentMode = document.getElementById('add-paymentMode').value;

        if (!date || !type || !category || !amount || !description || !paymentMode) {
            showMessage('Please fill all required fields.');
            return;
        }

        const formData = new FormData();
        formData.append('date', date);
        formData.append('type', type);
        formData.append('category', category);
        formData.append('amount', amount);
        formData.append('description', description);
        formData.append('paymentMode', paymentMode);

        fetch(webAppUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                showMessage('Data added successfully!');
                clearFormFields();
                fetchData(); 
            } else {
                showMessage('Failed to add data.');
            }
        })
        .catch(error => {
            console.error('Error adding data:', error);
            showMessage('Error adding data.');
        });
    }

    window.onload = () => {
        fetchData(); 
        populatePaymentModesDropdown();
    };
</script>
</body>
</html>
